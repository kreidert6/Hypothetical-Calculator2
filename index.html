<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Hypothetical Calculator</title>

    

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        h1 {
            text-align: center;
        }
        form {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
            border: 1px solid #ccc;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        label {
            display: block;
            margin-bottom: 10px;
        }
        input[type="text"],
        input[type="number"],
        input[type="date"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 15px;
            border: 1px solid #ccc;
            border-radius: 3px;
        }
        button[type="button"] {
            background-color: #007BFF;
            color: #fff;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
        }
        button[type="button"]:hover {
            background-color: #0056b3;
        }
        #result {
            text-align: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>What if I invested?</h1>

    <form>
        <label for="stockSymbol">Stock Symbol:</label>
        <input type="text" id="stockSymbol" required list="stockSymbols">

        <!-- The datalist to hold stock symbol suggestions -->
        <datalist id="stockSymbols"></datalist>

        <label for="investmentAmount">Investment Amount ($):</label>
        <input type="number" id="investmentAmount" required>

        <label for="investmentDate">Investment Date:</label>
        <input type="date" id="investmentDate" required>

        <button type="button" onclick="run()">CALCULATE</button>
    </form>

    <div class="loading" id="loading"></div>
    <div id="result"></div>

    <div>
        <canvas id="myChart"></canvas>
      </div>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        function run() {
        const stock_symbol = document.getElementById('stockSymbol').value;
        const investment_amount = document.getElementById('investmentAmount').value;
        const investment_date = document.getElementById('investmentDate').value;
        const api_key = '5OI48rnfXPLgW4VbFggC2RiamryB6pE2ZdqE2Ty1'
        const api_key2 = 'KSRMSRPN5YK0R57P'

        console.log(stock_symbol)
        console.log(investment_amount)
        console.log(investment_date)


        //const api_url = 'https://www.alphavantage.co/query?function=TIME_SERIES_WEEKLY_ADJUSTED&symbol=IBM&apikey=demo';
        const api_url = 'https://www.alphavantage.co/query?function=TIME_SERIES_WEEKLY_ADJUSTED&symbol=' + stock_symbol + '&apikey=' + api_key2
        getData(stock_symbol, investment_amount,investment_date, api_url);
      
      }
      async function getData(stock_symbol, investment_amount, investment_date, api_url) {
        const response = await fetch(api_url);
        const data = await response.json();

        const weekly_adjusted_prices = data['Weekly Adjusted Time Series'];
        
        const new_investment_date = findInvestmentDate(investment_date, weekly_adjusted_prices)
        const relevant_data = filterDates(new_investment_date, weekly_adjusted_prices)
        console.log(relevant_data)
        const chart_data = chartData(investment_amount, relevant_data)
      
        const dates = chart_data[0]
        const prices = chart_data[1]

        console.log(dates)
        console.log(prices)
      
        
        const investment_date_data = weekly_adjusted_prices[new_investment_date]
      

        const initial_shares = findInitialShares(investment_amount, investment_date_data)
        const shares_bought_through_dividends = findSharesBoughtThroughDividends(new_investment_date, weekly_adjusted_prices)
        
        const total_shares_owned = initial_shares + shares_bought_through_dividends
       
        const current_stock_price = getCurrentStockPrice(weekly_adjusted_prices)
      
        const current_value = total_shares_owned * current_stock_price

  
        updateResult(current_value)


        chartIt(dates, prices)
       

      }



      function filterDates(start_date, data){
        const filtered_data = {};
        for (const date in data) {
            if (date >= start_date) {
                filtered_data[date] = data[date];
            }
        }
        return filtered_data
      }
      function getPrices(data) {
        const adjustedClosePrices = [];

        // Iterate through the JSON data and extract the adjusted close prices
        for (const date in data) {      
            if (data.hasOwnProperty(date)) {
                const adjustedClose = parseFloat(data[date]["5. adjusted close"]);
                adjustedClosePrices.push(adjustedClose.toFixed(2));
            }
        }

        return adjustedClosePrices
      }
      function updateResult(current_value) {
            // Hide loading and show the result
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `<p><strong>Current Value:</strong> $${current_value.toFixed(2)}</p>`;

            const loadingDiv = document.getElementById('loading');
            loadingDiv.style.display = 'none';
        }
      
      function getCurrentStockPrice(weekly_adjusted_prices){
        const data = JSON.parse(JSON.stringify(weekly_adjusted_prices));

        // Find the most recent date among the keys
        const dates = Object.keys(data);
        const most_recent_date = dates[0]; // Assuming dates are in descending order

        // Access the adjusted close price of the most recent date
        const adjusted_close_price = data[most_recent_date]["5. adjusted close"];
        return adjusted_close_price
      }


      function findSharesBoughtThroughDividends(start_date, data){
      
        console.log("start date:" + start_date);

        const dates = Object.keys(data).reverse();
        console.log(dates)
        let start_processing = false;
        let shares_bought = 0

        for (const date of dates) {
          
            if (date === start_date) {
              console.log("triggered")
                start_processing = true;
            }

            if (start_processing) {
                const dividend_amount = parseFloat(data[date]["7. dividend amount"]);
            
                if (dividend_amount > 0) {
                    const stock_price = data[date]["5. adjusted close"]
                    shares_bought += dividend_amount / stock_price
                   
                    // Handle the dividend here
                }
            }

        }
        console.log("shares bought from dividends")
        console.log(shares_bought)
        return shares_bought;
      }


      function findInitialShares(amount, data){
        stock_price = data["5. adjusted close"]
        console.log("stock price")
        console.log(stock_price)

        stocks_bought = amount / stock_price
        console.log("stocks bought")
        console.log(stocks_bought)
        return stocks_bought
      }

      function findInvestmentDate(investment_date, weekly_adjusted_prices){
        let investment_date_obj = new Date(investment_date);
        
        
        let new_investment_date = investment_date
        console.log("starting new invest date: " + new_investment_date)

    
        if (!(new_investment_date in weekly_adjusted_prices)){
          let investment_date_obj = new Date(investment_date);
          new_investment_date = formatDate(investment_date_obj);
          while (!(new_investment_date in weekly_adjusted_prices)) {
            investment_date_obj = addDays(investment_date_obj, -1)
            new_investment_date = formatDate(investment_date_obj);
          
        }
      }
        console.log("returning date:" + new_investment_date)
        return new_investment_date 
        
      
      
        
    }
            


    function addDays(date, days) {
        const result = new Date(date);
        result.setDate(result.getDate() + days);
        return result;
    }

    function formatDate(date) {
        // Format the Date object as "YYYY-MM-DD"
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }








    function chartData(investment_amount, data){
       

       // Initial investment amount
      let sharesBought = 0; // Number of shares bought initially
      let currentValue = 0; // Current value of the investment
      const dailyValues = []; // Array to store daily values

      const sortedDates = Object.keys(data).sort();
      console.log(sortedDates)
      for (const date of sortedDates) {
          
          const adjustedClosePrice = parseFloat(data[date]["5. adjusted close"]);
          const dividendAmount = parseFloat(data[date]["7. dividend amount"]);

          
          if (sharesBought === 0) {
              // Calculate the number of shares bought on the first day
              sharesBought = investment_amount / adjustedClosePrice;
              console.log("investment amount: " +investment_amount )
              console.log(" price: "+ adjustedClosePrice)
              console.log("shares bought: " + sharesBought)
          }

          // Calculate the current value of the investment on this day
          

          if (!isNaN(dividendAmount) && dividendAmount > 0) {
              // Calculate the additional shares bought through dividends and adjust sharesBought
              const additionalSharesFromDividends = dividendAmount / adjustedClosePrice;
              sharesBought += additionalSharesFromDividends;
          }
          
          const currentValue = sharesBought * adjustedClosePrice;
          console.log("shares bought: " + sharesBought);
          console.log("close price: "+ adjustedClosePrice);
          console.log("current val: " + currentValue);

          // Log the current value and date to the array
          dailyValues.push({
              date: date,
              value: currentValue.toFixed(2),
          });
          console.log("shares owned:" + sharesBought);
         
      }
      const datesArray = [];

      // Extract the date values from the dailyValues array
      for (const entry of dailyValues) {
          datesArray.push(entry.date);
      }

      const valuesArray = [];

      // Extract the date values from the dailyValues array
      for (const entry of dailyValues) {
          valuesArray.push(parseFloat(entry.value));
      }

      const finalArray = [];

      finalArray.push(datesArray);
      finalArray.push(valuesArray);

      return finalArray;

    }


    function chartIt(x_data, y_data){

        const ctx = document.getElementById('myChart');
        if (ctx.chart) {
        ctx.chart.destroy();
    }
  
    ctx.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: x_data,
            datasets: [{
                label: 'Stock Price: ',
                data: y_data,
                borderWidth: 1,
                fill: {
                    target: 'origin',
                    above: 'rgb(173, 216, 230)',
                    below: 'rgb(0, 0, 255)'
                }
                

            
            }]
        },
        options: {
            scales: {
            y: {
                beginAtZero: true
            }
            }
        }
        });
        }



    </script>



</body>
</html>









